# 微信 4.1.6.14 适配计划（项目：weixin-fabu2）

文档版本：v2.0
最后更新：2026-01-15
适配目标：微信 4.1.6.14

## 文档使用说明
- 主体部分：用于指导 4.1.6.14 适配工作的执行。
- 附录部分：记录文档改进历程，供参考与复盘。
- 推荐阅读方式：
  - 首次阅读：完整阅读主体部分。
  - 执行时：对照步骤逐项完成。
  - 复盘时：参考附录了解改进点。

## 快速导航
- [目标与范围](#目标)
- [里程碑与时间预估](#里程碑与时间预估)
- [执行步骤](#step-0准备工作)
- [测试策略](#测试策略)
- [附录：版本对比](#附录版本对比分析)

## 目标
- 以最小改动支持微信 4.1.6.14（4.x）并保持现有功能稳定。

## 范围与影响
- 配置：默认微信版本改为 v4.0（4.x 统一使用 v4.0 选择器组）。
- 选择器：更新 selectors.yaml 的 v4.0 分组。
- 版本检测：4.x 进程/窗口类名识别。
- 环境检查：识别 4.x 主窗口/登录窗口。
- 图像模板（仅在匹配失败时）：重新截图替换。

## 里程碑与时间预估（可根据实际调整）
- Step 0 准备工作：0.5 天
- Step 1 UI 树采集：0.5 天
- Step 2 选择器更新：0.5-1 天
- Step 3 版本检测/环境检查：0.5 天
- Step 4 模板刷新（可选）：0.5 天
- Step 5 配置与验证：0.5 天
- 总计：2.5-3.5 天

## Step 0：准备工作
- 备份当前可用的 v3 配置（config.yaml、selectors.yaml、模板图片）。
- 准备微信 4.1.6.14 测试环境并登录。
- 确认 `detect_wechat4_deep.py` 可运行。
- 开启屏幕录制/截图，便于对比 UI 与调试。

## Step 1：采集 4.1 UI 树与控件属性
- 使用 `detect_wechat4_deep.py`（必要时配合 `detect_wechat4.py`）抓取 UI 树。
- 覆盖场景：
  - 主窗口（左侧导航）
  - 朋友圈入口
  - 发布编辑器窗口/对话框
  - 选择图片的系统对话框
- 记录 Name/ClassName/AutomationId/ControlType。
- 动态控件处理：
  - 打开目标页面后再抓取。
  - 必要时增加等待时间并提高 searchDepth。

## Step 2：更新 selectors.yaml（v4.0 分组）
- 校准 main_window（class_name/title/process_name）。
- 校准导航项：聊天、通讯录、收藏、朋友圈、视频号、搜索、设置。
- 校准朋友圈发布流程控件：发表按钮、文本输入、添加图片、提交按钮。
- 选择器优先级建议：
  - 优先 AutomationId；其次 Name；再用 ClassName + ControlType。
- 降级策略：
  - 主选择器失败时使用 fallback（更宽松的 Name 或 ControlType）。
  - 极端情况下回退到图像匹配。

## Step 3：版本检测与环境检查
- core/element_locator.py
  - 补充 4.x 进程路径识别（含 WeChatAppEx.exe）。
  - 统一将 4.1.x 识别为 v4.0 配置。
- core/wechat/version_detector.py
  - 校验主窗口类名（mmui::MainWindow）与进程名列表。
- core/env_checker.py
  - 将 mmui::MainWindow 纳入主窗口/登录窗口识别。
  - 可选：引用 VersionDetector 集中维护类名列表。

## Step 4：模板图片更新（按需）
- 仅当图像匹配失败时重截图：
  - data/templates/dots_btn.png
  - data/templates/comment_btn.png
  - data/templates/send_btn.png
  - data/templates/delete_btn.png
- 置信度策略：
  - 使用 config 中的 confidence_levels（如 0.8/0.6/0.4）。
  - 失败时缩小搜索区域并多阈值重试。

## Step 5：配置与默认值
- config.yaml：automation.wechat_version 设置为 v4.0。
- config.yaml.dist：保持与默认一致。

## 测试策略
- 单元测试
  - 版本检测：4.x 进程名与窗口类名识别。
  - 选择器解析：v4.0 分组读取、fallback 逻辑。
- 集成测试
  - 朋友圈完整发布流程（含图片选择）。
  - 群消息发送关键路径。
- 回归测试
  - v3.x 仍可用（如需兼容）。
- 边界测试
  - 不同语言包（中文/英文）。
  - 窗口最小化/非前台。
  - 多显示器与不同 DPI 设置。

## 回滚与兼容策略
- 使用独立分支（feature/wechat-4.1）。
- 保留 v3 与 v4 选择器并行结构。
- 适配失败时：
  - 回退 config.yaml 到 v3 默认。
  - 还原 selectors.yaml 与模板备份。

## 依赖与前置条件
- `detect_wechat4_deep.py` 已可运行并能输出 UI 树。
- uiautomation 在 4.1 上可识别 mmui 控件。
- 不新增第三方依赖，除非 UIA 识别失败。

## 风险说明（扩展）
- 不同语言包导致 Name 文案变化。
- 自定义控件导致 ControlType/Name 不稳定。
- 进程路径或进程名变化导致版本检测失败。
- 选择器变化引发性能波动。
- 未来 4.x 小版本变更造成维护成本增加。

## 成功标准
- 4.1.6.14 下主要流程可用且稳定。
- 如需支持 v3，回归测试通过。
- 性能无明显下降（< 10%）。
- 文档与配置示例更新完成。

## 验证清单
- 日志可正确识别 v4。
- 主窗口与导航按钮可定位。
- 朋友圈发布流程可执行。
- 图像匹配在必要时可用。

## 交付物
- 更新后的 selectors.yaml（v4.0）。
- 版本检测与环境检查改动。
- 可选：模板图片更新。
- 更新后的配置默认值与文档。

---

## 附录：版本对比分析

### 主要改进点总览
1) 语言本地化
- 从英文改为中文，更符合团队协作习惯，降低理解成本。

2) 新增完整项目管理维度
- 时间规划：补充了每一步耗时预估与总工期。
- 测试策略：从简单清单扩展为单元/集成/回归/边界测试体系。
- 回滚方案：新增分支策略与失败回退路径。

### 详细修改对比
新增内容：
- Step 0（准备工作）：备份、测试环境、工具可用性确认、调试辅助。

强化内容：
- Step 1（UI 树采集）：补充动态控件处理方案。
- Step 2（选择器更新）：增加优先级策略与降级策略。
- Step 4（模板图片）：补充置信度阈值与多次重试策略。

保持内容：
- Step 3 / Step 5：内容一致并中文化。

### 新增章节（6 项）
时间预估 | 测试策略 | 回滚方案 | 依赖说明 | 成功标准 | 风险扩展(3→5)

### 结构对比（概览）
- 旧版：目标/范围/文件清单/步骤/验证/风险/交付物。
- 新版：目标/范围/时间预估/准备工作/步骤/测试/回滚/依赖/风险/成功标准/验证/交付物。

### 关键改进亮点
- 从操作指引升级为可管理、可追踪的项目计划。
- 可执行性提升：时间/测试/回滚落地化。
- 团队协作友好：中文化 + 结构完整。

### 仍可优化（从 9 分到 10 分）
- 增加流程可视化（流程图）。
- 明确责任人分工。
- 设置检查点（CP1/CP2/CP3）。
- 增加沟通计划（站会/评审/验收）。

文档对比分析完成于 2026-01-15
