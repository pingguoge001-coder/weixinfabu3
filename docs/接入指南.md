# 激活码服务接入指南

本文档介绍如何将你的应用接入激活码服务，实现软件激活、授权管理功能。

## 服务地址

- **API 地址**: `https://pingguoge.zeabur.app/api`
- **管理后台**: `https://pingguoge.zeabur.app/admin`

## 一、在管理后台注册你的应用

### 1. 登录管理后台

访问 `https://pingguoge.zeabur.app/admin`，输入管理员密码登录。

### 2. 添加新应用

进入「应用管理」标签：
1. 填写应用标识（如 `my-app`，只能用英文、数字、横线）
2. 填写应用名称（如 `我的应用`）
3. 点击「添加应用」
4. **保存好生成的 `app_key` 和 `app_secret`**，后续接入需要用到

## 二、API 接口说明

### 公共请求头

所有 API 请求需要携带以下请求头进行身份验证：

```
X-App-Key: <你的app_key>
X-App-Secret: <你的app_secret>
```

### 1. 检查激活状态

检查某个设备是否已激活。

**请求**
```
GET /api/activation/check?device_id=<设备唯一标识>
```

**响应（已激活）**
```json
{
  "activated": true,
  "expiresAt": "2025-12-17T00:00:00.000Z",
  "daysRemaining": 7
}
```

**响应（未激活）**
```json
{
  "activated": false
}
```

### 2. 激活设备

使用激活码激活设备。

**请求**
```
POST /api/activation/activate
Content-Type: application/json

{
  "code": "ACTV-7D-ABCD1234",
  "device_id": "设备唯一标识",
  "user_name": "用户名",     // 可选
  "phone": "手机号"          // 可选
}
```

**响应（成功）**
```json
{
  "success": true,
  "message": "激活成功",
  "expiresAt": "2025-12-17T00:00:00.000Z",
  "days": 7
}
```

**响应（失败）**
```json
{
  "success": false,
  "message": "激活码不存在" // 或 "激活码已被使用" 等
}
```

### 3. 更新用户信息

更新已激活用户的信息。

**请求**
```
PUT /api/activation/user
Content-Type: application/json

{
  "device_id": "设备唯一标识",
  "user_name": "新用户名",
  "phone": "新手机号"
}
```

**响应**
```json
{
  "success": true,
  "message": "用户信息已更新"
}
```

## 三、客户端接入示例

### Node.js / Electron 示例

```typescript
import https from 'https';

const ACTIVATION_API = 'https://pingguoge.zeabur.app/api';
const APP_KEY = '你的app_key';
const APP_SECRET = '你的app_secret';

// 发送 HTTPS 请求
function request(method: string, path: string, body?: object): Promise<any> {
  return new Promise((resolve, reject) => {
    const url = new URL(ACTIVATION_API + path);

    const options: https.RequestOptions = {
      hostname: url.hostname,
      port: 443,
      path: url.pathname + url.search,
      method: method,
      headers: {
        'Content-Type': 'application/json',
        'X-App-Key': APP_KEY,
        'X-App-Secret': APP_SECRET,
      },
      timeout: 30000,
    };

    const req = https.request(options, (res) => {
      let data = '';
      res.on('data', chunk => data += chunk);
      res.on('end', () => {
        try {
          resolve(JSON.parse(data));
        } catch {
          reject(new Error('响应解析失败'));
        }
      });
    });

    req.on('error', reject);
    req.on('timeout', () => {
      req.destroy();
      reject(new Error('请求超时'));
    });

    if (body) {
      req.write(JSON.stringify(body));
    }
    req.end();
  });
}

// 检查激活状态
async function checkActivation(deviceId: string) {
  return await request('GET', `/activation/check?device_id=${encodeURIComponent(deviceId)}`);
}

// 激活设备
async function activateDevice(code: string, deviceId: string, userName?: string, phone?: string) {
  return await request('POST', '/activation/activate', {
    code,
    device_id: deviceId,
    user_name: userName,
    phone: phone,
  });
}

// 使用示例
async function main() {
  const deviceId = 'unique-device-id'; // 生成设备唯一标识

  // 检查是否已激活
  const status = await checkActivation(deviceId);
  if (status.activated) {
    console.log(`已激活，剩余 ${status.daysRemaining} 天`);
    return;
  }

  // 激活设备
  const result = await activateDevice('ACTV-7D-XXXXXXXX', deviceId);
  if (result.success) {
    console.log('激活成功！');
  } else {
    console.log('激活失败：', result.message);
  }
}
```

### 浏览器 / 前端示例

```javascript
const ACTIVATION_API = 'https://pingguoge.zeabur.app/api';
const APP_KEY = '你的app_key';
const APP_SECRET = '你的app_secret';

// 检查激活状态
async function checkActivation(deviceId) {
  const response = await fetch(
    `${ACTIVATION_API}/activation/check?device_id=${encodeURIComponent(deviceId)}`,
    {
      headers: {
        'X-App-Key': APP_KEY,
        'X-App-Secret': APP_SECRET,
      },
    }
  );
  return await response.json();
}

// 激活设备
async function activateDevice(code, deviceId, userName, phone) {
  const response = await fetch(`${ACTIVATION_API}/activation/activate`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-App-Key': APP_KEY,
      'X-App-Secret': APP_SECRET,
    },
    body: JSON.stringify({
      code,
      device_id: deviceId,
      user_name: userName,
      phone: phone,
    }),
  });
  return await response.json();
}
```

### Python 示例

```python
import requests

ACTIVATION_API = 'https://pingguoge.zeabur.app/api'
APP_KEY = '你的app_key'
APP_SECRET = '你的app_secret'

headers = {
    'X-App-Key': APP_KEY,
    'X-App-Secret': APP_SECRET,
}

# 检查激活状态
def check_activation(device_id):
    response = requests.get(
        f'{ACTIVATION_API}/activation/check',
        params={'device_id': device_id},
        headers=headers
    )
    return response.json()

# 激活设备
def activate_device(code, device_id, user_name=None, phone=None):
    response = requests.post(
        f'{ACTIVATION_API}/activation/activate',
        json={
            'code': code,
            'device_id': device_id,
            'user_name': user_name,
            'phone': phone,
        },
        headers=headers
    )
    return response.json()

# 使用示例
if __name__ == '__main__':
    device_id = 'unique-device-id'

    # 检查激活状态
    status = check_activation(device_id)
    if status.get('activated'):
        print(f"已激活，剩余 {status['daysRemaining']} 天")
    else:
        # 激活
        result = activate_device('ACTV-7D-XXXXXXXX', device_id)
        print(result)
```

## 四、设备标识生成建议

设备唯一标识（device_id）用于区分不同的设备/用户，建议的生成方式：

### Electron / Node.js
```javascript
import { machineIdSync } from 'node-machine-id';
const deviceId = machineIdSync();
```

### 浏览器
```javascript
// 使用 localStorage 存储生成的 UUID
function getDeviceId() {
  let deviceId = localStorage.getItem('device_id');
  if (!deviceId) {
    deviceId = crypto.randomUUID();
    localStorage.setItem('device_id', deviceId);
  }
  return deviceId;
}
```

### Python
```python
import uuid
import platform

def get_device_id():
    # 使用机器特征生成
    return str(uuid.uuid5(uuid.NAMESPACE_DNS, platform.node()))
```

## 五、激活码类型

| 类型 | 代码 | 有效期 |
|------|------|--------|
| 7天卡 | `7d` | 7 天 |
| 30天卡 | `30d` | 30 天 |
| 年卡 | `365d` | 365 天 |

激活码格式：`ACTV-{类型}-{随机码}`

示例：
- `ACTV-7D-ABCD1234`（7天卡）
- `ACTV-30D-EFGH5678`（30天卡）
- `ACTV-365D-IJKL9012`（年卡）

## 六、续期说明

用户可以在激活状态下使用新的激活码续期，续期逻辑：

```
新到期时间 = max(当前到期时间, 现在) + 新激活码天数
```

例如：用户还剩 3 天到期，使用 7 天卡续期，新到期时间 = 3 + 7 = 10 天后。

## 七、最佳实践

### 1. 本地缓存

建议在本地缓存激活状态，减少 API 调用：
- 启动时先读取本地缓存
- 后台异步刷新远程状态
- 网络故障时降级使用缓存

### 2. 错误处理

```javascript
try {
  const result = await activateDevice(code, deviceId);
  if (result.success) {
    // 激活成功
  } else {
    // 显示错误信息：result.message
  }
} catch (error) {
  // 网络错误，提示用户检查网络
}
```

### 3. 安全建议

- **不要在前端暴露 app_secret**，前端应通过自己的后端 API 中转
- 对于桌面应用（Electron），可以将密钥打包在代码中
- 定期检查激活状态，防止篡改本地缓存

## 八、常见问题

### Q: 激活码可以重复使用吗？
A: 不可以，每个激活码只能使用一次。

### Q: 一个激活码可以激活多个设备吗？
A: 不可以，一个激活码只能绑定一个设备。

### Q: 用户换设备怎么办？
A: 需要使用新的激活码，或在管理后台手动重置。

### Q: 如何生成激活码？
A: 在管理后台「激活码管理」中生成，支持批量生成和导出。

## 九、联系支持

如有问题，请联系管理员。
