# 问题修复记录 - 2026-01-20

## 问题概述

朋友圈发布流程在进入朋友圈之前就出错，无法正常执行发布操作。

---

## 问题1：微信主窗口被误判为朋友圈窗口

### 现象
日志显示 `找到微信 4.0 朋友圈窗口`，但实际上朋友圈窗口并未打开，程序把微信主窗口误判为朋友圈窗口。

### 原因
`controller.py` 的 `find_moments_window` 方法存在逻辑缺陷：
- `mmui::MainWindow`（微信主窗口类名）被列为朋友圈窗口的候选类名
- 验证逻辑只检查窗口内是否有"朋友圈"控件
- 但微信主窗口左侧导航栏本身就有"朋友圈"按钮，导致误判

### 修复
修改 `core/wechat/controller.py` 的 `find_moments_window` 方法：
1. 从候选类名列表中移除 `mmui::MainWindow`
2. 添加 `_is_real_moments_window` 验证函数，增加更严格的判断逻辑：
   - 如果是 `mmui::SNSWindow` → 直接认为是朋友圈窗口
   - 如果是 `mmui::MainWindow` → 检查窗口标题是否包含"朋友圈"，或是否有顶部"发表"按钮
   - 如果窗口标题是"微信"或"WeChat" → 返回 False（这是主窗口）

---

## 问题2："••" 按钮点击位置偏移

### 现象
在朋友圈详情页面，点击 "••" 按钮时位置偏了，没有点中按钮。

### 原因
配置文件中的偏移值不准确。

### 修复
修改 `config.yaml` 中的偏移配置：
```yaml
# 修改前
dots_btn_click_offset_x: -5
dots_btn_click_offset_y: 15

# 修改后
dots_btn_click_offset_x: 25
dots_btn_click_offset_y: 40
```

---

## 问题3：菜单弹出太慢导致评论按钮点击失败

### 现象
点击 "..." 按钮后，菜单还没完全弹出就点击评论按钮，导致点击失败。

### 原因
等待时间太短（0.5秒）。

### 修复
修改 `core/moment/publish_handler.py`，将等待时间从 0.5 秒改为 2 秒：
```python
# 修改前
time.sleep(0.5)

# 修改后
time.sleep(2)
```

---

## 问题4：发表按钮点击太快

### 现象
进入朋友圈后立即点击发表按钮，页面还没加载完成。

### 原因
没有等待页面加载。

### 修复
修改 `core/moment/publish_handler.py` 的 `_open_compose_dialog_v4` 方法，在点击发表按钮前增加 2 秒等待：
```python
# 等待朋友圈页面完全加载
time.sleep(2)
```

---

## 代码优化

### 1. 删除无效的图像识别方法
删除了查找发送按钮时的"方法1：图像识别"，因为每次都失败。现在直接使用基于 "..." 按钮的相对定位。

### 2. 删除查找详情窗口的逻辑
原本在点击第一条朋友圈后会尝试查找新打开的"详情"窗口，但实际上直接使用原窗口就可以，删除了这段不必要的逻辑。

### 3. 添加调试功能
添加了 `_debug_click_position` 方法，可以在点击位置保存截图并画标记，方便调试定位问题。

启用方法：在 `config.yaml` 中设置：
```yaml
ui_location:
  debug_click_position: true
  debug_dir: ./data/debug
```

---

## 测试脚本

创建了 `test_dots_click.py` 测试脚本，用于单独测试 "••" 按钮的定位和点击：
- 查找朋友圈详情窗口
- 定位 "••" 按钮
- 保存带标记的截图
- 移动鼠标到目标位置
- 询问是否点击

使用方法：
```bash
python test_dots_click.py
```

---

## 经验总结

### 为什么调试好的流程过几天又出错？

1. **代码逻辑 bug**：之前测试时某些条件恰好没触发隐藏的 bug（如主窗口误判问题）
2. **窗口状态不同**：之前测试时朋友圈窗口可能恰好已打开，跳过了有问题的步骤
3. **微信更新**：微信可能静默更新，UI 有细微变化

### 预防措施

1. 固定窗口位置：程序启动时强制重置窗口位置
2. 减少绝对坐标依赖：尽量使用相对定位
3. 增加等待时间：在关键步骤后增加适当等待
4. 完善日志：关键步骤打印详细信息，方便排查

---

## 修改的文件清单

1. `core/wechat/controller.py` - 修复朋友圈窗口误判
2. `core/moment/publish_handler.py` - 调整等待时间、删除无效逻辑
3. `config.yaml` - 调整偏移配置、启用调试
4. `test_dots_click.py` - 新增测试脚本
