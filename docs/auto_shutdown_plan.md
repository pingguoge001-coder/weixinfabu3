# 任务完成后自动关机功能 - 实现方案

## 一、功能概述

当所有发布队列中的任务执行完毕后，系统自动关闭电脑。

### 用户场景
- 用户设置好大量定时发布任务后，可以选择任务全部完成后自动关机
- 适合晚上或无人值守时使用

---

## 二、UI设计（线框图）

### 设置页面新增区域

```
┌─────────────────────────────────────────────────────────────┐
│  ⚙️ 系统设置                                                 │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  📁 路径设置                                         │   │
│  │  ...（现有内容）                                     │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  🔌 自动关机设置                          [新增区域] │   │
│  │  ┌──────────────────────────────────────────────┐   │   │
│  │  │                                              │   │   │
│  │  │  ☑️ 任务全部完成后自动关机                    │   │   │
│  │  │                                              │   │   │
│  │  │  关机延迟:  [ 60    ] 秒                     │   │   │
│  │  │            ↑                                 │   │   │
│  │  │         (数字输入框,范围30-300)              │   │   │
│  │  │                                              │   │   │
│  │  │  💡 提示: 关机前会显示倒计时，可随时取消      │   │   │
│  │  │                                              │   │   │
│  │  └──────────────────────────────────────────────┘   │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  🔊 语音播报设置                                     │   │
│  │  ...（现有内容）                                     │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 关机倒计时弹窗

```
┌────────────────────────────────────────┐
│         ⚠️ 即将自动关机                 │
├────────────────────────────────────────┤
│                                        │
│     所有任务已完成                      │
│                                        │
│     系统将在 [  45  ] 秒后关机          │
│                                        │
│     ┌──────────┐    ┌──────────┐      │
│     │  取消关机 │    │ 立即关机  │      │
│     └──────────┘    └──────────┘      │
│                                        │
└────────────────────────────────────────┘
```

---

## 三、技术实现

### 1. 配置文件修改 (config.yaml)

```yaml
# 新增配置项
automation:
  auto_shutdown_enabled: false    # 是否启用自动关机
  auto_shutdown_delay: 60         # 关机延迟（秒）
```

### 2. 涉及修改的文件

| 文件 | 修改内容 |
|-----|---------|
| `config.yaml` | 添加 automation 配置项 |
| `gui/settings_tab.py` | 添加自动关机设置UI |
| `gui/main_window.py` | 添加关机逻辑和倒计时弹窗 |
| `services/config_manager.py` | 添加配置读写方法 |

### 3. 核心逻辑流程

```
任务完成回调 (_on_scheduled_task_finished)
    │
    ▼
检查队列是否全部为空
    │
    ├── 否 → 继续等待下一任务
    │
    └── 是 → 检查自动关机是否启用
                │
                ├── 否 → 仅显示"所有任务已完成"通知
                │
                └── 是 → 显示倒计时弹窗
                            │
                            ├── 用户点击"取消" → 取消关机
                            │
                            ├── 倒计时结束 → 执行关机命令
                            │
                            └── 用户点击"立即关机" → 立即执行
```

### 4. 关机命令 (Windows)

```python
import os
# 执行关机
os.system(f'shutdown -s -t 0')
# 取消关机
os.system('shutdown -a')
```

---

## 四、实现步骤

1. **Step 1**: 修改 `config.yaml`，添加自动关机配置项
2. **Step 2**: 修改 `services/config_manager.py`，添加配置读写方法
3. **Step 3**: 修改 `gui/settings_tab.py`，添加设置UI控件
4. **Step 4**: 创建关机倒计时弹窗组件
5. **Step 5**: 修改 `gui/main_window.py`，添加队列完成检测和关机触发逻辑
6. **Step 6**: 测试功能

---

## 五、注意事项

- 关机前必须有倒计时提示，防止误操作
- 用户随时可以取消关机
- 关机延迟最少30秒，给用户反应时间
- 仅在所有队列（朋友圈、群发等）都为空时触发
